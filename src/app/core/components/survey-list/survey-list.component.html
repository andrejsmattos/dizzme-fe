<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-1">Minhas Pesquisas</h1>
          <p class="text-muted">
            Gerencie todas as suas pesquisas de experiência do cliente
          </p>
        </div>
        <button class="btn btn-primary" (click)="createNewSurvey()">
          <i class="bi bi-plus-lg me-2"></i>Nova Pesquisa
        </button>
      </div>
    </div>
  </div>

  <div class="row mb-3 g-3">
    <div class="col-md-6">
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input
          type="text"
          class="form-control"
          placeholder="Buscar pesquisas..."
          [(ngModel)]="searchTerm"
          (input)="filterSurveys()"
        />
      </div>
    </div>
    <div class="col-md-6">
      <select
        class="form-select"
        [(ngModel)]="statusFilter"
        (change)="filterSurveys()"
      >
        <option value="">Todos os status</option>
        <option value="ACTIVE">Ativas</option>
        <option value="DRAFT">Rascunhos</option>
        <option value="PAUSED">Pausadas</option>
        <option value="COMPLETED">Finalizadas</option>
      </select>
    </div>
  </div>

  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-primary"></div>
    <p class="mt-2">Carregando pesquisas...</p>
  </div>

  <div
    *ngIf="!isLoading && filteredSurveys.length === 0 && surveys.length === 0"
    class="text-center py-5"
  >
    <i class="bi bi-clipboard-data display-1 text-muted mb-3"></i>
    <h4>Nenhuma pesquisa encontrada</h4>
    <p class="text-muted mb-4">
      Crie sua primeira pesquisa para começar a coletar feedback dos clientes
    </p>
    <button class="btn btn-primary" (click)="createNewSurvey()">
      <i class="bi bi-plus-lg me-2"></i>Criar Primeira Pesquisa
    </button>
  </div>

  <div
    *ngIf="!isLoading && filteredSurveys.length === 0 && surveys.length > 0"
    class="text-center py-5"
  >
    <i class="bi bi-search display-1 text-muted mb-3"></i>
    <h4>Nenhuma pesquisa encontrada</h4>
    <p class="text-muted">Tente ajustar os filtros de busca</p>
  </div>

  <div class="row" *ngIf="!isLoading && filteredSurveys.length > 0">
    <div class="col-lg-4 col-md-6 mb-4" *ngFor="let survey of filteredSurveys">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <span
              class="badge"
              [class.bg-success]="survey.active && survey.status === 'ACTIVE'"
              [class.bg-warning]="survey.status === 'DRAFT'"
              [class.bg-secondary]="survey.status === 'PAUSED'"
              [class.bg-info]="survey.status === 'COMPLETED'"
            >
              {{ getStatusLabel(survey.status, survey.active) }}
            </span>
            <div class="btn-group" dropdown>
              <button class="btn btn-sm btn-link text-muted" dropdownToggle>
                <i class="bi bi-three-dots-vertical"></i>
              </button>
              <ul *dropdownMenu class="dropdown-menu">
                <li>
                  <a class="dropdown-item" (click)="editSurvey(survey.id)">
                    Editar
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" (click)="showQRCode(survey)"
                    >QR Code
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" (click)="copyLink(survey.id)">
                    Copiar Link
                  </a>
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a
                    class="dropdown-item text-danger"
                    (click)="confirmDelete(survey)"
                    >Excluir</a
                  >
                </li>
              </ul>
            </div>
          </div>

          <h5 class="card-title">{{ survey.title }}</h5>
          <p class="card-text text-muted small flex-grow-1">
            {{ survey.description | slice : 0 : 100
            }}{{
              survey.description && survey.description.length > 100 ? "..." : ""
            }}
          </p>

          <div class="mt-auto">
            <div class="row text-center border-top pt-3">
              <div class="col-4">
                <strong class="d-block">{{ survey.questionsCount }}</strong>
                <small class="text-muted">Perguntas</small>
              </div>
              <div class="col-4">
                <strong class="d-block">{{ survey.responsesCount }}</strong>
                <small class="text-muted">Respostas</small>
              </div>
              <div class="col-4">
                <strong class="d-block">{{
                  survey.createdAt | date : "dd/MM"
                }}</strong>
                <small class="text-muted">Criado</small>
              </div>
            </div>

            <div class="d-flex gap-2 mt-3">
              <button
                class="btn btn-outline-primary btn-sm flex-grow-1"
                (click)="viewSurvey(survey.id)"
              >
                <i class="bi bi-eye"></i>Ver
              </button>
              <button
                class="btn btn-primary btn-sm flex-grow-1"
                (click)="viewStats(survey.id)"
              >
                <i class="bi bi-graph-up"></i>Estatísticas
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de QRCode -->
  <div
    class="modal fade"
    tabindex="-1"
    [ngClass]="{ 'show d-block': selectedSurvey && qrCodeData }"
    *ngIf="selectedSurvey && qrCodeData"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">QR Code - {{ selectedSurvey.title }}</h5>
          <button
            type="button"
            class="btn-close"
            (click)="selectedSurvey = null; qrCodeData = null"
          ></button>
        </div>
        <div class="modal-body text-center">
          <img
            [src]="qrCodeData.base64Image"
            [alt]="selectedSurvey.title"
            style="max-width: 100%; height: auto"
          />
          <p class="mt-2 small text-muted">Escaneie para acessar a pesquisa</p>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-outline-secondary"
            (click)="selectedSurvey = null; qrCodeData = null"
          >
            Fechar
          </button>
          <button class="btn btn-primary" (click)="downloadQRCode()">
            Baixar QR Code
          </button>
          <button class="btn btn-outline-primary" (click)="shareQRCode()">
            Compartilhar QR Code
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
